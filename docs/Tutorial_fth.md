
# ğŸŒŸ ç®€ä»‹

SimAI æ˜¯ä¸€ä¸ªç»¼åˆæ€§å¤§è§„æ¨¡AIè®­ç»ƒæ¨¡æ‹Ÿå·¥å…·åŒ…ï¼Œæä¾›ä¸‰å¤§æ¨¡æ‹Ÿåœºæ™¯ï¼š

1. **SimAI-Analytical** - åŸºäºè§£æçš„æ¨¡æ‹Ÿå·¥å…·ï¼Œé€šè¿‡æŠ½è±¡åº•å±‚ç½‘ç»œé€šä¿¡ç»†èŠ‚å®ç°å¿«é€Ÿåœºæ™¯éªŒè¯ã€‚é‡‡ç”¨ç®€åŒ–çš„busbwï¼ˆæ€»çº¿å¸¦å®½ï¼‰ä¼°ç®—é›†åˆé€šä¿¡/ç‚¹å¯¹ç‚¹é€šä¿¡æ—¶é—´ï¼Œä¸»è¦åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

    * *æ€§èƒ½åˆ†æ*ï¼šå¯¹æ¯”ä¸åŒæ¨¡å‹çš„å®Œæˆæ—¶é—´ï¼ˆå¦‚ç ”ç©¶ä¸“å®¶æ•°é‡å¯¹MoEæ¨¡å‹è®­ç»ƒæ€§èƒ½çš„å½±å“ï¼‰
    * *æ¡†æ¶çº§å¹¶è¡Œå‚æ•°ä¼˜åŒ–*ï¼šå¹³è¡¡ä¼˜åŒ–TP/EP/PPå‚æ•°åˆ†æç«¯åˆ°ç«¯æ—¶åºå½±å“
    * *è§„æ¨¡æ‰©å±•æ¢ç´¢*ï¼šç ”ç©¶ç‰¹å®šåœºæ™¯ä¼˜åŒ–çš„è§„æ¨¡æ‰©å±•åŸŸå†…å¹¶è¡Œå‚æ•°æ€§èƒ½
    * *è§„æ¨¡æ‰©å±•å¸¦å®½é€‰æ‹©*ï¼šç ”ç©¶ä¸åŒGPUæ€§èƒ½çš„æˆæœ¬æ•ˆç›Šå¸¦å®½é…ç½®

> ğŸ’¡ *å½“å‰æ”¯æŒæ‰‹åŠ¨busbw.yamlé…ç½®ã€‚åŸºäºå¹¶è¡Œåœºæ™¯çš„è‡ªåŠ¨busbwæ¨ç†åŠŸèƒ½å³å°†å¼€æºï¼Œè¯¦æƒ…è¯·è”ç³»æˆ‘ä»¬ã€‚âœ¨*

2. **SimAI-Simulation(NS-3)** - é«˜ä¿çœŸå…¨æ ˆæ¨¡æ‹Ÿå·¥å…·ï¼Œå¯ç†è®ºé›†æˆä»»ä½•çº¯ç½‘ç»œæ¨¡æ‹Ÿå™¨ã€‚æä¾›LLMè®­ç»ƒæœŸé—´é€šä¿¡è¡Œä¸ºçš„ç»†ç²’åº¦å¤ç°ï¼Œå½“å‰æ”¯æŒNS-3ä½œä¸ºç½‘ç»œåç«¯ï¼ˆé¼“åŠ±é›†æˆæ–°ç½‘ç»œæ¨¡æ‹Ÿå·¥å…·ï¼‰ã€‚é‡ç‚¹ç ”ç©¶é¢†åŸŸï¼š
    * *é›†åˆé€šä¿¡ç®—æ³•ç ”ç©¶*ï¼šè®¾è®¡ä¼˜åŒ–éäº¤æ¢æ¶æ„åŠæ–°å…´ç½‘ç»œæ‹“æ‰‘çš„é›†åˆé€šä¿¡æµé‡æ¨¡å¼
    * *ç½‘ç»œåè®®ç ”ç©¶*ï¼šè¯„ä¼°ä¼˜åŒ–ä¸åŒæ¶æ„ä¸‹çš„ç½‘ç»œåè®®ã€æ‹¥å¡æ§åˆ¶ç®—æ³•ã€è·¯ç”±æœºåˆ¶ç­‰åº•å±‚ç½‘ç»œæŠ€æœ¯
    * *æ–°å‹ç½‘ç»œæ¶æ„è®¾è®¡*ï¼šæ¢ç´¢åˆ›æ–°ç½‘ç»œæ¶æ„

> ğŸ’¡ æˆ‘ä»¬å¼ºçƒˆå»ºè®®ç ”ç©¶äººå‘˜åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œåˆ›æ–°æ‰©å±•å’Œçªç ´æ€§ç ”ç©¶ï¼ˆé€‚åˆé¡¶ä¼šçº§åˆ«ï¼‰ã€‚åŠ å…¥ç¤¾åŒºæˆ–é€šè¿‡é‚®ä»¶è”ç³»æˆ‘ä»¬ï¼Œæˆ‘ä»¬å°†ä¸ºæœ‰æ½œåŠ›çš„ç ”ç©¶æ–¹å‘æä¾›æŠ€æœ¯æ”¯æŒï¼âœ¨

3. **SimAI-Physical(TODO)**

å„ç»„ä»¶è¯¦ç»†åŠŸèƒ½è¯·å‚è€ƒ [SimCCL](https://github.com/aliyun/SimCCL ) å’Œ [ns-3-alibabacloud](https://github.com/aliyun/ns-3-alibabacloud )

# ğŸ› ï¸ ç¯å¢ƒæ­å»º

æ­£å¸¸è¿è¡ŒSimAIéœ€è¦ä½¿ç”¨[AICB](https://github.com/aliyun/aicb?tab=readme-ov-file#generate-workloads-for-simulation-simai )å·¥å…·ç”ŸæˆWorkloadæ–‡ä»¶ã€‚åˆ›å»ºç²¾ç¡®Workloadå¯èƒ½éœ€è¦ä½¿ç”¨AIOBåŠŸèƒ½ç¡®å®šå„ç±»è®¡ç®—å†…æ ¸æ—¶åºï¼Œè¿™éœ€è¦GPUç¯å¢ƒã€‚å› æ­¤æ¨èåœ¨æœ€æ–°**NGCé•œåƒ**ä¸­ç›´æ¥æ‰§è¡ŒSimAIå…¨æ ˆå·¥å…·åŒ…ã€‚

> ğŸ’¡ **é‡è¦æç¤º**ï¼šSimAI-Simulationç¼–è¯‘éœ€è¦ç§»é™¤é¢„è£…çš„ninjaï¼ˆNVIDIAç³»ç»Ÿé»˜è®¤å®‰è£…ï¼‰ï¼Œå¯ç”¨ä»¥ä¸‹å‘½ä»¤å¸è½½ï¼š
> ```bash
> apt remove ninja-build && pip uninstall ninja
> ```

æ„å»ºè¯´æ˜ï¼š

```bash
# å…‹éš†ä»“åº“
$ git clone https://github.com/aliyun/SimAI.git 
$ cd ./SimAI/

# å…‹éš†å­æ¨¡å—
$ git submodule update --init --recursive
# ç¡®ä¿ä½¿ç”¨æœ€æ–°æäº¤
$ git submodule update --remote

# ç¼–è¯‘SimAI-Analytical
$ ./scripts/build.sh -c analytical

# ç¼–è¯‘SimAI-Simulation (ns3)
$ ./scripts/build.sh -c ns3
```

# ğŸŒ SimAI-Analytical ä½¿ç”¨æŒ‡å—
## ğŸ“ å·¥ä½œè´Ÿè½½ç”Ÿæˆ

ä½¿ç”¨[AICB](https://github.com/aliyun/aicb )çš„[SimAI-WorkloadGenerator](https://github.com/aliyun/aicb?tab=readme-ov-file#generate-workloads-for-simulation-simai )åŠŸèƒ½ç”Ÿæˆæ¨¡æ‹Ÿå·¥ä½œè´Ÿè½½ã€‚å°†ç”Ÿæˆç±»ä¼¼[workload_analytical.txt](../example/workload_analytical.txt)çš„`.txt`æ–‡ä»¶ï¼ŒåŒ…å«ï¼š

- `model_parallel_NPU_group`: Tensorå¹¶è¡Œè§„æ¨¡
- `ep`: ä¸“å®¶æ¨¡å‹å¹¶è¡Œè§„æ¨¡
- `pp`: æµæ°´çº¿æ¨¡å‹å¹¶è¡Œè§„æ¨¡
- `vpp`: è™šæ‹Ÿæµæ°´çº¿å¹¶è¡Œï¼ˆé»˜è®¤ï¼š`--num-layers-per-virtual-pipeline-stage=1`æœ€å°PPæ°”æ³¡ï¼‰

> ğŸ’¡ *è¯¦æƒ…è¯·å‚è€ƒ[AICB workloadæ•™ç¨‹](https://github.com/aliyun/aicb/blob/master/training/tutorial.md#workload )*

## ğŸ”§ æ€»çº¿å¸¦å®½è®¾ç½®

SimAI-Analyticalé€šè¿‡ç›´æ¥æŒ‡å®šbusbwæŠ½è±¡åº•å±‚ç½‘ç»œç»†èŠ‚ä¼°ç®—é›†åˆé€šä¿¡æ—¶é—´ã€‚è‡ªå®šä¹‰å„åœºæ™¯é€šä¿¡busbwå¯ä½¿ç”¨[busbw.yaml](../example/busbw.yaml)æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```yaml
test
TP:
  allreduce,: 300      # TPåœºæ™¯AllReduceå¸¦å®½300GB/s
  allgather,: 280
  reducescatter,: 280
  alltoall,: 230
DP:
  allreduce,: null
  allgather,: 380      # DPåœºæ™¯AllGatherå¸¦å®½380GB/s
  reducescatter,: 380
  alltoall,: null
EP:
  allreduce,: null
  allgather,: 45       # DP_EPåœºæ™¯AllGatherå¸¦å®½45GB/s
  reducescatter,: 45   # DP_EPåœºæ™¯ReduceScatterå¸¦å®½45GB/s
  alltoall,: 80        # EPåœºæ™¯AlltoAllå¸¦å®½80GB/s
```
> ğŸ” *éœ€è¦è‡ªåŠ¨åŒ–busbwè®¡ç®—ï¼ˆè€ƒè™‘é›†ç¾¤è§„æ¨¡ã€æ¶æ„ã€å¹¶è¡Œå‚æ•°ã€å°æ¶ˆæ¯è°ƒæ•´å’Œå»¶è¿Ÿï¼‰ï¼Ÿæ¬¢è¿è®¨è®ºäº¤æµï¼âœ¨*

## ğŸ–¥ï¸ è§£ææ¨¡æ‹Ÿ

è¿è¡Œè§£ææ¨¡æ‹Ÿå‘½ä»¤ï¼š

```bash
$ ./bin/SimAI_analytical -w example/workload_analytical.txt -g 9216 -g_p_s 8 -r test- -busbw example/busbw.yaml
```

### å¿…éœ€å‚æ•°

| å‚æ•° | é•¿æ ¼å¼ | æè¿° |
|:---------:|:----------|:------------|
| `-w` | `--workload` | æŒ‡å®šå·¥ä½œè´Ÿè½½æ–‡ä»¶è·¯å¾„ |
| `-g` | `--gpus` | æŒ‡å®šæ¨¡æ‹ŸGPUè§„æ¨¡ |
| `-g_p_s` | `--gpus-per-server` | æŒ‡å®šå•æœºGPUè§„æ¨¡ |
| `-r` | `--result` | æŒ‡å®šè¾“å‡ºæ–‡ä»¶è·¯å¾„å‰ç¼€ï¼ˆé»˜è®¤ï¼š`./results/`ï¼‰<br>æ¨èåŒ…å«æ¨¡æ‹Ÿå‚æ•°ï¼Œä¾‹å¦‚ï¼š<br>`A100-llama405b-tp8-pp16-dp128-ga16-ep1-NVL8` |
| `-busbw` | `--bus-bandwidth` | æŒ‡å®šbusbwæ–‡ä»¶è·¯å¾„<br>ï¼ˆæ¨èç›´æ¥ä¿®æ”¹`example/busbw.yaml`ï¼‰ |

### å¯é€‰å‚æ•°

| å‚æ•° | é•¿æ ¼å¼ | æè¿° |
|:---------:|:----------|:------------|
| `-v` | `--visual` | æ˜¯å¦ç”Ÿæˆå¯è§†åŒ–æ–‡ä»¶ |

### é€šä¿¡ç»„é‡å æ¯”ä¾‹

ä»¥ä¸‹å‚æ•°æŒ‡å®šé€šä¿¡ç»„é‡å æ¯”ä¾‹ï¼ˆé»˜è®¤0è¡¨ç¤ºæ— é‡å ï¼‰ï¼š

| å‚æ•° | é•¿æ ¼å¼ | æè¿° | èŒƒå›´ |
|:---------:|:----------|:------------|:------|
| `-dp_o` | `--dp-overlap-ratio` | DPé‡å æ¯”ä¾‹ | [0.0-1.0] |
| `-ep_o` | `--ep-overlap-ratio` | EPé‡å æ¯”ä¾‹ | [0.0-1.0] |
| `-tp_o` | `--tp-overlap-ratio` | TPé‡å æ¯”ä¾‹ | [0.0-1.0] |
| `-pp_o` | `--pp-overlap-ratio` | PPé‡å æ¯”ä¾‹ | [0.0-1.0] |

> ğŸ“ *ç”±äºé‡å ç­–ç•¥å¤šæ ·ä¸”åœºæ™¯ä¾èµ–ï¼Œæˆ‘ä»¬ä¼˜å…ˆé‡‡ç”¨ç®€å•é«˜æ•ˆæ–¹æ³•ç›´æ¥æŒ‡å®šé‡å æ¡ä»¶ã€‚*

## ç»“æœåˆ†æ

### åŸå§‹æ•°æ®

æ­£å¸¸è¿è¡ŒSimAI-Analyticalå°†ç”ŸæˆCSVè¾“å‡ºï¼Œç¬¬äºŒè¡Œä¸ºæ‘˜è¦ä¿¡æ¯ï¼ŒåŒ…å«æš´éœ²æ—¶é—´ã€å„é€šä¿¡ç»„è®¡ç®—æ—¶é—´ç»å¯¹å€¼/ç™¾åˆ†æ¯”åŠå•æ¬¡è¿­ä»£ç«¯åˆ°ç«¯æ—¶é—´ï¼Œä¸‹æ–¹ä¸ºå„å±‚å…·ä½“æ“ä½œç»†èŠ‚ã€‚

<img src="./images/simai_raw.png" alt="simai_raw" width="50%">

### å¯è§†åŒ–

è‹¥è¿è¡Œæ—¶æŒ‡å®š`-v`å‚æ•°å°†ç”Ÿæˆï¼š

<img src="./images/simai_visual.png" alt="simai_visual" width="30%">

# SimAI-Simulation ä½¿ç”¨æŒ‡å—
## ğŸ“ å·¥ä½œè´Ÿè½½ç”Ÿæˆ

ä¸SimAI-Analyticalç›¸åŒï¼Œä½¿ç”¨[AICB](https://github.com/aliyun/aicb )çš„[SimAI-WorkloadGenerator](https://github.com/aliyun/aicb?tab=readme-ov-file#generate-workloads-for-simulation-simai )åŠŸèƒ½ç”Ÿæˆã€‚

## ğŸ”§ ç½‘ç»œæ‹“æ‰‘è®¾ç½®
è¿è¡ŒSimAI-Simulatorå‰éœ€è¦ç”Ÿæˆns-3-alibabacloudå¯è¯†åˆ«çš„æ‹“æ‰‘æ–‡ä»¶ã€‚
### æ‹“æ‰‘æ¨¡æ¿
ä¸ºæå‡ä¾¿æ·æ€§ï¼Œæˆ‘ä»¬æä¾›5ç§å¸¸è§æ¶æ„æ¨¡æ¿ï¼ˆSpectrum-Xã€å•å¹³é¢AlibabaHPNã€åŒå¹³é¢AlibabaHPNå’ŒDCN+ï¼‰ï¼Œé€šè¿‡`-topo`å‚æ•°è®¾ç½®ã€‚è¿™äº›å›¾ç¤ºæ¦‚è§ˆå¦‚ä¸‹ã€‚è‹¥éœ€äº†è§£åŒToRå’ŒåŒå¹³é¢åŒºåˆ«ï¼Œè¯·é˜…è¯»[HPN 7.0è®ºæ–‡](https://ennanzhai.github.io/pub/sigcomm24-hpn.pdf )
<table>
  <tr>
    <td><img src="./images/Spectrum-X.jpg" alt="Spectrum-X" style="width:100%"><br><p>Spectrum-X(å•Pod)</p></td>
  </tr>
  <tr>
    <td><img src="./images/DCN+SingleToR.jpg" alt="DCN+" style="width:100%"><br><p>DCN+å•ToR(å•Pod)</p></td>
    <td><img src="./images/DCN+DualToR.jpg" alt="DCN+" style="width:100%"><br><p>DCN+åŒToR(å•Pod)</p></td>    
  </tr>
  <tr>
    <td><img src="./images/HPNSinglePlane.jpg" alt="AlibabaHPN_SinglePlane" style="width:100%"><br><p>AlibabaHPNå•å¹³é¢(å•Pod)</p></td>
    <td><img src="./images/HPNDualPlane.jpg" alt="AlibabaHPN_DualPlane" style="width:100%"><br><p>AlibabaHPNåŒå¹³é¢(å•Pod)</p></td>
    
  </tr>
</table>

ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆå›¾ç¤º8GPUçš„Spectrum-Xæ‹“æ‰‘ï¼š
```bash
python3 ./astra-sim-alibabacloud/inputs/topo/gen_Topo_Template.py -topo Spectrum-X -g 8 -psn 1
```
<img src="./images/Spectrum.jpg" alt="Spectrum" style="width:50%">

ä¸‹è¡¨ç»™å‡ºå„å±‚çº§å‚æ•°æè¿°åŠå„æ¨¡æ¿é»˜è®¤å‚æ•°ã€‚ç”¨æˆ·å¯é€šè¿‡æ›´æ”¹`-topo`åç§°å’Œå¯¹åº”`-g`å‚æ•°ç”Ÿæˆå¯¹åº”ç»“æ„æ‹“æ‰‘ã€‚ï¼ˆæœªæŒ‡å®šGPUæ•°æ—¶å°†ç”Ÿæˆå„æ¨¡æ¿å•Podæ‹“æ‰‘ï¼Œç›®å‰æš‚ä¸æ”¯æŒå¤šPodï¼‰

| å‚æ•°å±‚çº§ | å‚æ•°  | æè¿° |
|-----------------|------------|-------------|
| æ•´ä½“ç»“æ„ | `-topo`    | æ‹“æ‰‘æ¨¡æ¿ |
|          | `-g`       | GPUæ•°é‡ |
|          | `--dp`     | å¯ç”¨åŒå¹³é¢ï¼ˆé»˜è®¤å•å¹³é¢ï¼‰ |
|          | `--ro`     | å¯ç”¨Rail-Optimized |
|          | `--dt`     | å¯ç”¨åŒç½‘å¡åŒToR |
|          | `-er`      | é”™è¯¯ç‡ |
| ä¸»æœºå†…   | `-gps`     | æ¯æœåŠ¡å™¨GPUæ•° |
|          | `-gt`      | GPUç±»å‹ |
|          | `-nsps`    | æ¯æœåŠ¡å™¨NVäº¤æ¢æœºæ•° |
|          | `-nvbw`    | NVLinkå¸¦å®½ |
|          | `-nl`      | NVLinkå»¶è¿Ÿ |
|          | `-l`       | ç½‘å¡å»¶è¿Ÿ |
| åˆ†æ®µå†…   | `-bw`      | ç½‘å¡åˆ°ASWå¸¦å®½ |
|          | `-asw`     | ASWäº¤æ¢æœºæ•° |
|          | `-nps`     | æ¯äº¤æ¢æœºç½‘å¡æ•°ï¼ˆASWè¿æ¥GPUæ•°ï¼‰ |
| Podå†…    | `-psn`     | PSWäº¤æ¢æœºæ•° |
|          | `-apbw`    | ASWåˆ°PSWå¸¦å®½ |
|          | `-app`     | æ¯PSWè¿æ¥ASWæ•° |

| å‚æ•°å±‚çº§ | å‚æ•°  | Spectrum-X  | AlibabaHPNå•å¹³é¢ | AlibabaHPNåŒå¹³é¢ | DCN+åŒå¹³é¢ | DCN+å•å¹³é¢ |
|-----------------|------------|-------------|-------------------------|-----------------------|---------------|---------------|
| æ•´ä½“ç»“æ„ | `-topo`    | `Spectrum-X`| `AlibabaHPN`            | `AlibabaHPN`          | `DCN+`        | `DCN+`        |
|          | `-g`       | 4096        | 15360                   | 15360                 | 512           | 512           |
|          | `--dp`     | false       | false                   | true                  | false         | false         |
|          | `--ro`     | true        | true                    | true                  | false         | false         |
|          | `--dt`     | false       | true                    | true                  | true          | false         |
|          | `-er`      | 0           | 0                       | 0                     | 0             | 0             |
| ä¸»æœºå†…   | `-gps`     | 8           | 8                       | 8                     | 8             | 8             |
|          | `-gt`      | H100        | H100                    | H100                  | H100          | A100          |
|          | `-nsps`    | 1           | 1                       | 1                     | 1             | 1             |
|          | `-nvbw`    | 2880Gbps    | 2880Gbps                | 2880Gbps              | 2880Gbps      | 2880Gbps      |
|          | `-nl`      | 0.000025ms  | 0.000025ms              | 0.000025ms            | 0.000025ms    | 0.000025ms    |
|          | `-l`       | 0.0005ms    | 0.0005ms                | 0.0005ms              | 0.0005ms      | 0.0005ms      |
| åˆ†æ®µå†…   | `-bw`      | 400Gbps     | 200Gbps                 | 200Gbps               | 200Gbps       | 400Gbps       |
|          | `-asw`     | 64          | 120                     | 120                   | 2             | 1             |
|          | `-nps`     | 64          | 128                     | 128                   | 128           | 64            |
| Podå†…    | `-psn`     | 64          | 120                     | 120                   | 8             | 4             |
|          | `-apbw`    | 400Gbps     | 400Gbps                 | 400Gbps               | 400Gbps       | 400Gbps       |
|          | `-app`     | 64          | 240                     | 120                   | 8             | 4             |

é€šè¿‡ä¸åŒ`-topo`åç§°å’Œå‚æ•°å¯ç”Ÿæˆå„æ¨¡æ¿æ‹“æ‰‘ï¼š
åŒå¹³é¢AlibabaHPNï¼ˆ64GPUï¼Œ16asnï¼Œ16psnï¼‰ï¼š
```bash
python3 ./astra-sim-alibabacloud/inputs/topo/gen_Topo_Template.py -topo AlibabaHPN --dp -g 64 -asn 16 -psn 16
```
åŒToR DCNï¼ˆ128GPUï¼Œ2asnï¼Œ8psnï¼‰ï¼š
```bash
python3 ./astra-sim-alibabacloud/inputs/topo/gen_Topo_Template.py -topo DCN+ --dt -g 128 -asn 2 -psn 8
```
æ³¨æ„ï¼šSpectrum-Xä¸æ”¯æŒ`--ro` `--dt` `--dp`ï¼ˆå›ºå®šä¸ºRail-Optimizedå•ToRå•å¹³é¢ï¼‰ï¼ŒAlibabaHPNä¸æ”¯æŒ`--ro` `--dt`ï¼ˆå›ºå®šä¸ºRail-OptimizedåŒå¹³é¢/å•å¹³é¢ï¼‰ï¼ŒDCN+ä¸æ”¯æŒ`--ro` `--dp`ï¼ˆå›ºå®šä¸ºå•ToR/åŒToRï¼‰ã€‚

ç”¨æˆ·å¯è‡ªå®šä¹‰æ‹“æ‰‘ï¼Œä¾‹å¦‚æ„é€ 32GPUã€200Gbpså¸¦å®½ã€A100ã€8psnçš„Rail-Optimizedå•ToRæ‹“æ‰‘ï¼š
```bash
python3 ./astra-sim-alibabacloud/inputs/topo/gen_Topo_Template.py -g 32 -bw 200Gbps -gt A100 -psn 8 --ro
```

## ğŸ–¥ï¸ SimAI-NS3 æ¨¡æ‹Ÿ

```bash
$ AS_SEND_LAT=3 AS_NVLS_ENABLE=1 ./bin/SimAI_simulator -t 16 -w ./example/microAllReduce.txt -n  ./Spectrum-X_8g_8gps_400Gbps_H100  -c astra-sim-alibabacloud/inputs/config/SimAI.conf
```

| ç¯å¢ƒå˜é‡å | æè¿°                      | é»˜è®¤å€¼                             |
|---------------------------|----------------------------------|-------------------------------------------|
| `AS_LOG_LEVEL`            | æ—¥å¿—ç­‰çº§                        | `DEBUG`, `INFO`, `WARNING`, `ERROR`, `UNKNOWN`; é»˜è®¤ `INFO` |
| `AS_PXN_ENABLE`           | å¯ç”¨PXN                       | `0/1`; é»˜è®¤ `false`                 |
| `AS_NVLS_ENABLE`          | å¯ç”¨NVLS                      | `0/1`; é»˜è®¤ `false`                 |
| `AS_SEND_LAT`             | è®¾ç½®åŒ…å‘é€å»¶è¿Ÿ       | é»˜è®¤ `6`ï¼Œå•ä½ `us`              |
| `AS_NVLSTREE_ENABLE`      | å¯ç”¨NVLSTREE                  | é»˜è®¤ `false`                        |

| å‚æ•°                  | æè¿°                              | é»˜è®¤å€¼                                                      |
|----------------------------|------------------------------------------|--------------------------------------------------------------------|
| `-t  --thread`            | å¤šçº¿ç¨‹åŠ é€Ÿçº¿ç¨‹æ•° | é»˜è®¤ `1`; å¯ç”¨å¤šçº¿ç¨‹æ—¶æ§åˆ¶åœ¨ `8` åˆ° `16` ä¹‹é—´ |
| `-w  --workload`          | å·¥ä½œè´Ÿè½½è·¯å¾„                         | `./microAllReduce.txt`                                             |
| `-n  --network-topo`      | ç½‘ç»œæ‹“æ‰‘è·¯å¾„                    | None    

## RING VS NVLS
### workload
```bash
HYBRID_TRANSFORMER_FWD_IN_BCKWD model_parallel_NPU_group: 8 ep: 1 pp: 1 vpp: 8 ga: 1 all_gpus: 32 checkpoints: 0 checkpoint_initiates: 0
6
embedding_layer     -1 556000  ALLREDUCE   16777216      1       NONE 0        1      NONE   0      1 
...
```
### NVLSæ‹“æ‰‘æ–‡ä»¶ && è¿è¡Œ
```bash
cd SimAI
./scripts/build.sh -c ns3
python3 ./astra-sim-alibabacloud/inputs/topo/gen_Topo_Template.py --ro -g 32 -gt H100 -bw 400Gbps -nvbw 1360Gbps 
AS_SEND_LAT=12 AS_NVLS_ENABLE=1 ./bin/SimAI_simulator -t 8 -w ./example/microAllReduce.txt -n ./Rail_Opti_SingleToR_32g_8gps_400Gbps_H100 -c ./astra-sim-alibabacloud/inputs/config/SimAI.conf
```
### RINGæ‹“æ‰‘æ–‡ä»¶ && è¿è¡Œ
```bash
python3 ./astra-sim-alibabacloud/inputs/topo/gen_Topo_Template.py --ro -g 32 -gt H100 -bw 400Gbps -nvbw 1440Gbps
AS_SEND_LAT=2 AS_PXN_ENABLE=1 ./bin/SimAI_simulator -t 8 -w ./example/microAllReduce.txt -n ./Rail_Opti_SingleToR_32g_8gps_400Gbps_H100 -c ./astra-sim-alibabacloud/inputs/config/SimAI.conf
```
### ç»“æœ
| æ¶ˆæ¯å¤§å° | NVLS   | RING   |
|----------|--------|--------|
| 16M      | 148.88 | 141.84 |
| 32M      | 178.04 | 153.68 |
| 64M      | 197.38 | 160.60 |
| 128M     | 208.70 | 163.85 |
| 256M     | 214.87 | 165.72 |
| 512M     | 218.09 | 166.68 |


## Spectrum-Xæ¶æ„ VS DCN+æ¶æ„
### workload
```bash
HYBRID_TRANSFORMER_FWD_IN_BCKWD model_parallel_NPU_group: 8 ep: 1 pp: 1 vpp: 8 ga: 1 all_gpus: 256 checkpoints: 0 checkpoint_initiates: 0
1
embedding_layer     -1 556000         NONE 0        1      NONE   0      1 ALLREDUCE   536870912      1
```
### ç½‘ç»œæ‹“æ‰‘æ–‡ä»¶
```bash
# DCN+æ‹“æ‰‘æ–‡ä»¶ (å•ToR, éRail-Optimized)
python3 ./astra-sim-alibabacloud/inputs/topo/gen_Topo_Template.py -topo DCN+ -g 256 -psn 64 -bw 400Gbps 
# Spectrumæ‹“æ‰‘æ–‡ä»¶ (å•ToR, Rail-Optimized)
python3 ./astra-sim-alibabacloud/inputs/topo/gen_Topo_Template.py -topo Spectrum-X -g 256
```
### è¿è¡Œå‘½ä»¤
```bash
# DCN+è¿è¡Œå‘½ä»¤
AS_SEND_LAT=2 ./bin/SimAI_simulator -t 8 -w ./example/microAllReduce.txt -n ./DCN+SingleToR_256g_8gps_400Gbps_H100 -c ./astra-sim-alibabacloud/inputs/config/SimAI.conf
# HPN7.0è¿è¡Œå‘½ä»¤
AS_SEND_LAT=2 ./bin/SimAI_simulator -t 8 -w ./example/microAllReduce.txt -n ./Spectrum-X_256g_8gps_400Gbps_H100 -c ./astra-sim-alibabacloud/inputs/config/SimAI.conf
```
| æ¶ˆæ¯å¤§å° | Spectrum-X  | DCN-å•ToR|
|----------|-------------|--------------|
| 16M      | 33.095585   | 23.332048    |
| 32M      | 38.572166   | 25.762846    |
| 64M      | 42.049648   | 23.677116    |
| 128M     | 44.036110   | 35.209461    |
| 256M     | 45.101425   | 36.205692    |
| 512M     | 45.653648   | 36.242008    |

# SimAI-Physical ä½¿ç”¨æŒ‡å—
å½“å‰æ¨¡æ‹Ÿå™¨å…¼å®¹ns3ç¦»æ•£äº‹ä»¶æ¨¡æ‹Ÿå™¨ä½œä¸ºç½‘ç»œåç«¯ï¼Œä»¥åŠç‰©ç†ç½‘ç»œåç«¯ç”¨äºç‰©ç†åŒ…æ³¨å…¥ã€‚

## ç¼–è¯‘
SimAI-Phyå½“å‰ä½¿ç”¨roceV2åè®®è¿›è¡Œæµé‡ç”Ÿæˆã€‚ç¼–è¯‘éœ€è¦ä¾èµ–RDMAç‰©ç†è®¾å¤‡ç›¸å…³çš„libverbsåŠMPIç¨‹åºã€‚ç¼–è¯‘å‰è¯·éªŒè¯ç¯å¢ƒèƒ½å¦æˆåŠŸè¿è¡ŒåŸºç¡€RDMA perfetestæµé‡ç”Ÿæˆå·¥å…·å¹¶æ”¯æŒç›¸å…³MPIç¨‹åºã€‚
```bash
# å…‹éš†ä»“åº“
$ git clone https://github.com/aliyun/SimAI.git 
$ cd ./SimAI/

# å…‹éš†å­æ¨¡å—
$ git submodule update --init --recursive
# ç¡®ä¿ä½¿ç”¨æœ€æ–°æäº¤
$ git submodule update --remote

# ç¼–è¯‘SimAI-Analytical
$ ./scripts/build.sh -c analytical

# ç¼–è¯‘SimAI-Simulation (ns3)
$ ./scripts/build.sh -c ns3

# ç¼–è¯‘SimAI-phynet (phynet)
$ sudo yum install openmpi openmpi-devel
$ export MPI_INCLUDE_PATH=/usr/include/openmpi-x86_64/ 
$ export MPI_BIN_PATH=/usr/lib64/openmpi/bin/mpic++	
$ ./scripts/build.sh -c Phy
```
## å·¥ä½œè´Ÿè½½ç”Ÿæˆ
SimAI-Phyç‰©ç†æµé‡ç”Ÿæˆæ‰€éœ€å·¥ä½œè´Ÿè½½ä¸Sim-Simulationç›¸åŒï¼Œé€šè¿‡AICBç”Ÿæˆã€‚

### ç¤ºä¾‹å·¥ä½œè´Ÿè½½
```bash
HYBRID_TRANSFORMER_FWD_IN_BCKWD model_parallel_NPU_group: 2 ep: 1 pp: 1 vpp: 8 ga: 1 all_gpus: 2 checkpoints: 0 checkpoint_initiates: 0
10
mlp_norm    	    -1	1055000	 ALLGATHER	  1073741824	1055000	      NONE	         0	1055000	      NONE	         0	       100
...
```
## å‡†å¤‡ä¸»æœºåˆ—è¡¨
ä¸»è¦ä»»åŠ¡æ˜¯å‡†å¤‡å¯åŠ¨MPIç¨‹åºæ‰€éœ€çš„IPåˆ—è¡¨ï¼Œè¿™ä¸nccl-testä¸åŒã€‚è¿™é‡Œçš„IPæ•°é‡åº”ä¸å‚ä¸ç‰©ç†æµé‡ç”Ÿæˆçš„å®é™…ç½‘å¡æ•°é‡åŒ¹é…ï¼Œè€Œéå‚ä¸ç‰©ç†æµé‡ç”Ÿæˆçš„èŠ‚ç‚¹æ•°é‡ã€‚
```bash
33.255.199.130
33.255.199.129
```
## è¿è¡Œ
### MPIè¿è¡Œ
```bash 
/usr/lib64/openmpi/bin/mpirun -np 2 -host 33.255.199.130,33.255.199.129 --allow-run-as-root -x AS_LOG_LEVEL=0  ./bin/SimAI_phynet ./hostlist -g 2 -w ./example/microAllReduce.txt
```
ä»¥ä¸‹è¾“å‡ºè¡¨æ˜ç¨‹åºå·²è¿è¡Œå®Œæˆã€‚

<img src="./images/Sim-phynet_finished.png" alt="Sim-phynet_finished" width="40%">

## MPIç¨‹åºå‚æ•°è®¾ç½®

| å‚æ•°        | æè¿°                                           | é»˜è®¤å€¼ |
|------------------|-------------------------------------------------------|---------------|
| -np              | è¿›ç¨‹æ•°                              | NULL          |
| -host            | IPåˆ—è¡¨                                               | NULL          |
| --allow-run-as-root | å…è®¸MPIç¨‹åºä»¥rootæƒé™è¿è¡Œ      | FALSE         |
## SimAI-phynetå‚æ•°è®¾ç½®

| å‚æ•°        | æè¿°                  | é»˜è®¤å€¼                                           |
|------------------|------------------------------|----------------------------------------------------------|
| hostlist         | ä¸»æœºIPåˆ—è¡¨                 | NULL                                                     |
| -w --workload    | å·¥ä½œè´Ÿè½½è·¯å¾„             | ./microAllReduce.txt                                     |
| -i --gid_index   | ç½‘ç»œæ‹“æ‰‘è·¯å¾„        | 0                                                        |
| -g --gpus        | GPUæ•°é‡               | 8 (åº”ä¸ä¸»æœºIPåˆ—è¡¨ä¸­çš„IPæ•°ä¸€è‡´) |